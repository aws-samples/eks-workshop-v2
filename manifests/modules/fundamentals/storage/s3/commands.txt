# Step : Prepare the environment (GOOD)
prepare-environment fundamentals/storage/s3

# Step : Shows container image
kubectl describe deployment -n assets

# Step : Show container build images (cat.jpg, dog.jpg, hamster.jpg, bird.jpg)
kubectl exec --stdin deployment/assets \
  -n assets -- bash -c "ls /usr/share/nginx/html/assets/"


# Step: Scale up deployment for multiple replicas
kubectl scale -n assets --replicas=2 deployment/assets
kubectl rollout status -n assets deployment/assets --timeout=60s

# Step : Put image in first pod
POD_NAME=$(kubectl -n assets get pods -o jsonpath='{.items[0].metadata.name}')
kubectl exec --stdin $POD_NAME \
  -n assets -- bash -c 'touch /usr/share/nginx/html/assets/horse.jpg'

# Step : Confirm image not in second pod
POD_NAME=$(kubectl -n assets get pods -o jsonpath='{.items[1].metadata.name}')
kubectl exec --stdin $POD_NAME \
  -n assets -- bash -c 'ls /usr/share/nginx/html/assets'




# Step : Attach addon to EKS cluster (GOOD)
eksctl create addon --name aws-mountpoint-s3-csi-driver --cluster $EKS_CLUSTER_NAME --service-account-role-arn $S3_CSI_ADDON_ROLE --force

# Step : Show mountpoint exists
kubectl get daemonset s3-csi-node -n kube-system




---- Test until here first and then proceed -----

# Step : Run this to create PV and PVC separately
envsubst < ~/environment/eks-workshop/modules/fundamentals/storage/s3/deployment/s3pvclaim.yaml | kubectl apply -f -

# Run this as once and load environment variables
kubectl kustomize ~/environment/eks-workshop/modules/fundamentals/storage/s3/deployment \
  | envsubst | kubectl apply -f-

  kubectl debug -n assets -it <podname> --image=<debug image> --target=<podname>

# Run to deploy separately
kubectl apply -f ~/environment/eks-workshop/modules/fundamentals/storage/s3/deployment/deployment.yaml

# RUN THIS TO DO TOGETHER!!
kubectl apply -k ~/environment/eks-workshop/modules/fundamentals/storage/s3/deployment
kubectl apply -k ~/environment/eks-workshop/modules/fundamentals/storage/s3/deployment -f <(envsubst < s3pvclaim.yaml)


# Step : Nginx deployment (test)


# Step : Interact with deployment


# Step : Navigate to S3 bucket and see file




### EXTRA INFORMATION ###

# Run this to view persistent volumes/storage class
kubectl get pv
kubectl get pvc
kubectl get storageclass


# Reset environment steps:
Scale down deployment properly
kubectl scale -n assets --replicas=0 deployment/assets

Delete pvc
k delete pvc s3-claim -n assets

Delete pv
k delete pv s3-pv

cleanup environment in a snap!
sh ~/environment/eks-workshop/modules/fundamentals/storage/s3/.workshop/cleanup.sh

# Useful container commands:
k logs [pod-name] -c [container-name] -n assets
kubectl exec -it [pod-name] -c [container-name] -- /bin/sh
id
ls -l /[mountpoint-dir]


