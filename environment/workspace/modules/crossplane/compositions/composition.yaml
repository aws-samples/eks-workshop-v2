apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: rds-mysql.awsblueprints.io
spec:
  compositeTypeRef:
    apiVersion: awsblueprints.io/v1alpha1
    kind: XRelationalDatabase
  writeConnectionSecretsToNamespace: crossplane-system
  resources:
    - base:
        apiVersion: database.aws.crossplane.io/v1beta1
        kind: DBSubnetGroup
        spec:
          forProvider:
            region: us-east-1
            description: "rds-mysql"
            subnetIds:
            - subnet-03467c2555e1804a2
            - subnet-0ab2caa411026e424
    - base:
        apiVersion: ec2.aws.crossplane.io/v1beta1
        kind: SecurityGroup
        spec:
          forProvider:
            region: us-east-1
            vpcId: vpc-07ce7322edd11a248
            description: "rds-mysq-sg"
            ingress:
              - ipProtocol: tcp
                fromPort: 3306
                toPort: 3306
                ipRanges:
                  - cidrIp: "0.0.0.0/0"
      patches:
        - fromFieldPath: "metadata.uid"
          toFieldPath: "spec.forProvider.groupName"
          transforms:
            - type: string
              string:
                fmt: "rds-mysql-sg-%s"
    - base:
        apiVersion: rds.aws.crossplane.io/v1alpha1
        kind: DBInstance
        spec:
          forProvider:
            region: us-east-1
            applyImmediately: true
            autogeneratePassword: true
            dbSubnetGroupNameSelector:
              matchControllerRef: true
            dbInstanceClass: db.t4g.micro
            masterUsername: admin
            engine: mysql
            engineVersion: "8.0"
            dbName: to-be-patched
            allocatedStorage: 20
            skipFinalSnapshot: true
            publiclyAccessible: false
            vpcSecurityGroupIDs: []
            vpcSecurityGroupIDSelector:
              matchControllerRef: true
            masterUserPasswordSecretRef:
              key: password
              name: to-be-patched
              namespace: crossplane-system
      patches:
        - fromFieldPath: spec.secret.namespace
          toFieldPath: spec.writeConnectionSecretToRef.namespace
        - fromFieldPath: spec.secret.name
          toFieldPath: spec.writeConnectionSecretToRef.name
        - fromFieldPath: "spec.storageGB"
          toFieldPath: "spec.forProvider.allocatedStorage"
        - fromFieldPath: "spec.databaseName"
          toFieldPath: "spec.forProvider.dbName"
        - fromFieldPath: "metadata.uid"
          toFieldPath: "spec.forProvider.masterUserPasswordSecretRef.name"
          transforms:
            - type: string
              string:
                fmt: "%s-password"
      connectionDetails:
      - fromConnectionSecretKey: username
      - fromConnectionSecretKey: password
      - fromConnectionSecretKey: endpoint
      - fromConnectionSecretKey: port