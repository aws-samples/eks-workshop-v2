AWSTemplateFormatVersion: "2010-09-09"
Description: Creates an IAM role for the EKS workshop IDE
Resources:
  EksWorkshopIdeRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: ${Env}-ide-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action:
              - sts:AssumeRole

  EksWorkshopIamPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - !Ref EksWorkshopIdeRole
      ManagedPolicyName: ${Env}-ide-iam
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - iam:CreateRole
              - iam:GetRolePolicy
              - iam:DetachRolePolicy
              - iam:AttachRolePolicy
              - iam:PutRolePolicy
              - iam:DeleteRolePolicy
              - iam:DeleteRole
              - iam:ListInstanceProfilesForRole
              - iam:ListAttachedRolePolicies
              - iam:ListRolePolicies
              - iam:TagRole
              - iam:PassRole
              - sts:AssumeRole
            Resource:
              - arn:aws:iam::${Account}:role/${Env}*
              - arn:aws:iam::${Account}:role/eksctl-${Env}*
          - Effect: Allow
            Action:
              - iam:CreatePolicy
              - iam:DeletePolicy
              - iam:GetPolicyVersion
              - iam:ListPolicyVersions
              - iam:TagPolicy
              - iam:GetPolicy
            Resource:
              - arn:aws:iam::${Account}:policy/${Env}*
              - arn:aws:iam::${Account}:policy/eksctl-${Env}*
          - Effect: Allow
            Action:
              - iam:CreateInstanceProfile
              - iam:DeleteInstanceProfile
              - iam:GetInstanceProfile
              - iam:TagInstanceProfile
              - iam:RemoveRoleFromInstanceProfile
              - iam:AddRoleToInstanceProfile
            Resource:
              - arn:aws:iam::${Account}:instance-profile/${Env}*
              - arn:aws:iam::${Account}:instance-profile/eksctl-${Env}*
              - arn:aws:iam::${Account}:instance-profile/eks-*
          - Effect: Allow
            Action:
              - iam:CreateUser
              - iam:DeleteUser
              - iam:TagUser
              - iam:GetUser
              - iam:ListGroupsForUser
              - iam:*SSHPublicKey
            Resource:
              - arn:aws:iam::${Account}:user/${Env}*
          - Effect: Allow
            Action:
              - iam:ListOpenIDConnectProviders
              - iam:CreateOpenIDConnectProvider
              - iam:DeleteOpenIDConnectProvider
              - iam:TagOpenIDConnectProvider
              - iam:GetOpenIDConnectProvider
              - iam:GetRole
            Resource: ["*"]
          - Effect: Allow
            Action:
              - iam:CreateServiceLinkedRole
            Resource: ["*"]
            Condition:
              StringEquals:
                iam:AWSServiceName:
                  - eks.amazonaws.com
                  - eks-nodegroup.amazonaws.com
                  - eks-fargate.amazonaws.com

  EksWorkshopBasePolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - !Ref EksWorkshopIdeRole
      ManagedPolicyName: ${Env}-ide-base
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - eks:*
              - ec2:CreateLaunchTemplate
              - ec2:DeleteLaunchTemplate
              - sts:GetCallerIdentity
            Resource: ["*"]
          - Effect: Allow
            Action:
              - cloudformation:CreateStack
            Resource:
              - arn:aws:cloudformation:${Region}:${Account}:stack/eksctl-${Env}*
            Condition:
              "Null":
                cloudformation:RoleARN: "true"
          - Effect: Allow
            Action:
              - cloudformation:DeleteStack
            Resource:
              - arn:aws:cloudformation:${Region}:${Account}:stack/eksctl-${Env}*
            Condition:
              "Null":
                cloudformation:RoleARN: "true"
          - Effect: Allow
            Action:
              - cloudformation:Get*
              - cloudformation:Describe*
              - cloudformation:List*
              - cloudformation:TagResource
            Resource: ["*"]
          - Effect: Allow
            Action:
              - autoscaling:Get*
              - autoscaling:Describe*
            Resource: ["*"]
          - Effect: Allow
            Action:
              - ecr-public:GetAuthorizationToken
              - sts:GetServiceBearerToken
            Resource: ["*"]
          - Effect: Allow
            Action:
              - kms:CreateKey
              - kms:TagResource
              - kms:ScheduleKeyDeletion
              - kms:CreateGrant
              - kms:EnableKeyRotation
              - kms:GetKeyPolicy
              - kms:GetKeyRotationStatus
              - kms:ListResourceTags
              - kms:PutKeyPolicy
            Resource: ["*"]
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:DescribeKey
              - kms:EnableKeyRotation
              - kms:Encrypt
              - kms:GenerateDataKey
              - kms:GenerateDataKeyWithoutPlaintext
            Resource: ["*"]
            Condition:
              StringLike:
                kms:RequestAlias: "alias/${Env}*"
          - Effect: Allow
            Action:
              - kms:CreateAlias
              - kms:DeleteAlias
            Resource:
              - "arn:aws:kms:${Region}:${Account}:alias/${Env}*"
              - "arn:aws:kms:${Region}:${Account}:key/*"
          - Effect: Allow
            Action:
              - kms:List*
              - kms:Get*
              - kms:Describe*
            Resource: ["*"]

  EksWorkshopEc2Policy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Roles:
        - !Ref EksWorkshopIdeRole
      ManagedPolicyName: ${Env}-ide-ec2
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - ec2:Get*
              - ec2:Describe*
              - ec2:List*
              - ec2:RunInstances
            Resource: ["*"]
          - Effect: Allow
            Action:
              - ec2:TerminateInstances
            Resource: ["*"]
            Condition:
              StringLike:
                aws:ResourceTag/env:
                  - ${Env}*
          - Effect: Deny
            Action: ec2:RunInstances
            Resource:
              - arn:aws:ec2:*:*:instance/*
            Condition:
              ForAnyValue:StringNotLike:
                ec2:InstanceType:
                  - m5.large
                  - t4g.medium
                  - c*.large
          - Effect: Allow
            Action:
              - ec2:CreateVpc
              - ec2:CreateSubnet
              - ec2:CreateRouteTable
              - ec2:CreateRoute
              - ec2:CreateInternetGateway
              - ec2:AttachInternetGateway
              - ec2:AssociateRouteTable
              - ec2:ModifyVpcAttribute
              - ec2:CreateSecurityGroup
              - ec2:AllocateAddress
              - ec2:ReleaseAddress
              - ec2:DisassociateAddress
              - ec2:CreateNetworkAclEntry
              - ec2:DeleteNetworkAclEntry
              - ec2:CreateNatGateway
              - ec2:DeleteNatGateway
            Resource: ["*"]
          - Effect: Allow
            Action:
              - ec2:DeleteVpc
              - ec2:DeleteSubnet
              - ec2:DeleteRouteTable
              - ec2:DeleteRoute
              - ec2:DeleteInternetGateway
              - ec2:DetachInternetGateway
              - ec2:DisassociateRouteTable
              - ec2:ModifyVpcAttribute
              - ec2:ModifySubnetAttribute
              - ec2:AuthorizeSecurityGroup*
              - ec2:UpdateSecurityGroupRuleDescriptionsEgress
              - ec2:RevokeSecurityGroup*
              - ec2:DeleteSecurityGroup
              - ec2:ModifySecurityGroupRules
              - ec2:UpdateSecurityGroupRuleDescriptionsIngress
            Resource: ["*"]
            Condition:
              StringLike:
                aws:ResourceTag/env:
                  - ${Env}*
          - Effect: Allow
            Action:
              - ec2:AuthorizeSecurityGroup*
              - ec2:RevokeSecurityGroup*
            Resource: ["*"]
            Condition:
              StringLike:
                aws:ResourceTag/aws:eks:cluster-name:
                  - ${Env}*
          - Effect: Allow
            Action:
              - ec2:CreateTags
              - ec2:DeleteTags
            Resource: ["*"]
          - Effect: Allow
            Action:
              - ec2:AssociateVpcCidrBlock
              - ec2:DisassociateVpcCidrBlock
            Resource: ["arn:aws:ec2:${Region}:${Account}:vpc/*"]
            Condition:
              StringLike:
                aws:ResourceTag/env:
                  - ${Env}*

  EksWorkshopLabsPolicy:
    Type: AWS::IAM::ManagedPolicy
    DependsOn:
      - EksWorkshopIdeRole
    Properties:
      Roles:
        - !Ref EksWorkshopIdeRole
      ManagedPolicyName: ${Env}-labs-ec2
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - aps:CreateWorkspace
              - aps:TagResource
            Resource: ["*"]
            Condition:
              StringLike:
                aws:RequestTag/env:
                  - ${Env}*
          - Effect: Allow
            Action:
              - aps:DeleteWorkspace
              - aps:Describe*
              - aps:List*
              - aps:QueryMetrics
            Resource: ["*"]
            Condition:
              StringLike:
                aws:ResourceTag/env:
                  - ${Env}*
          - Effect: Allow
            Action:
              - dynamodb:ListTables
            Resource: ["*"]
          - Effect: Allow
            Action:
              - dynamodb:CreateTable
              - dynamodb:DeleteTable
              - dynamodb:DescribeTable
              - dynamodb:DescribeContinuousBackups
              - dynamodb:ListTagsOfResource
              - dynamodb:DescribeTimeToLive
              - dynamodb:Scan
              - dynamodb:TagResource
            Resource:
              - arn:aws:dynamodb:${Region}:${Account}:table/${Env}*
          - Effect: Allow
            Action:
              - secretsmanager:ListSecrets
            Resource: ["*"]
          - Effect: Allow
            Action:
              - secretsmanager:CreateSecret
              - secretsmanager:DeleteSecret
              - secretsmanager:DescribeSecret
            Resource:
              - arn:aws:secretsmanager:${Region}:${Account}:secret:${Env}*
          - Effect: Allow
            Action:
              - secretsmanager:ListSecrets
            Resource: ["*"]
          - Effect: Allow
            Action:
              - sqs:CreateQueue
              - sqs:DeleteQueue
              - sqs:GetQueueAttributes
              - sqs:SetQueueAttributes
              - sqs:TagQueue
              - sqs:ListQueueTags
            Resource:
              - arn:aws:sqs:${Region}:${Account}:${Env}*
          - Effect: Allow
            Action:
              - rds:DescribeDBInstances
            Resource: ["*"]
          - Effect: Allow
            Action:
              - rds:CreateDBInstance
              - rds:CreateTenantDatabase
              - rds:DeleteDBInstance
              - rds:DeleteTenantDatabase
              - rds:DescribeDBInstances
              - rds:AddTagsToResource
              - rds:ListTagsForResource
            Resource:
              - arn:aws:rds:${Region}:${Account}:db:${Env}*
          - Effect: Allow
            Action:
              - rds:CreateDBInstance
              - rds:CreateDBSubnetGroup
              - rds:DeleteDBSubnetGroup
              - rds:DescribeDBSubnetGroups
              - rds:AddTagsToResource
              - rds:ListTagsForResource
            Resource:
              - arn:aws:rds:${Region}:${Account}:subgrp:${Env}*
          - Effect: Allow
            Action:
              - lambda:AddPermission
              - lambda:CreateFunction
              - lambda:DeleteFunction
              - lambda:GetFunction
              - lambda:GetFunctionCodeSigningConfig
              - lambda:GetPolicy
              - lambda:GetRuntimeManagementConfig
              - lambda:ListVersionsByFunction
              - lambda:RemovePermission
            Resource:
              - arn:aws:lambda:${Region}:${Account}:function:${Env}*
          - Effect: Allow
            Action:
              - es:CreateDomain
              - es:DeleteDomain
              - es:DescribeDomain
              - es:DescribeDomainConfig
              - es:GetCompatibleVersions
              - es:ListTags
              - es:AddTags
            Resource:
              - arn:aws:es:${Region}:${Account}:domain/${Env}*
          - Effect: Allow
            Action:
              - elasticloadbalancing:Describe*
              - elasticloadbalancing:Get*
            Resource: ["*"]
          - Effect: Allow
            Action:
              - cloudwatch:DeleteDashboards
              - cloudwatch:GetDashboard
              - cloudwatch:PutDashboard
            Resource:
              - arn:aws:cloudwatch::${Account}:dashboard/*
          - Effect: Allow
            Action:
              - ecr:CreateRepository
              - ecr:DeleteRepository
              - ecr:DescribeRepositories
              - ecr:ListTagsForResource
              - ecr:TagResource
            Resource:
              - arn:aws:ecr:${Region}:${Account}:repository/retail-store-sample*
              - arn:aws:ecr:${Region}:${Account}:repository/${Env}*
          - Effect: Allow
            Action:
              - codepipeline:ListTagsForResource
            Resource: ["*"]
          - Effect: Allow
            Action:
              - codepipeline:CreatePipeline
              - codepipeline:DeletePipeline
              - codepipeline:Get*
            Resource:
              - arn:aws:codepipeline:${Region}:${Account}:${Env}*
          - Effect: Allow
            Action:
              - guardduty:CreateDetector
              - guardduty:DeleteDetector
              - guardduty:ListDetectors
            Resource: ["*"]
          - Effect: Allow
            Action:
              - logs:DescribeLogGroups
              - logs:ListTagsForResource
            Resource: ["*"]
          - Effect: Allow
            Action:
              - logs:CreateLogGroup
              - logs:DeleteLogGroup
              - logs:DeleteSubscriptionFilter
              - logs:PutRetentionPolicy
              - logs:PutSubscriptionFilter
              - logs:TagResource
              - logs:TagLogGroup
              - logs:Get*
              - logs:Describe*
              - logs:List*
            Resource:
              - arn:aws:logs:${Region}:${Account}:log-group:${Env}*
              - arn:aws:logs:${Region}:${Account}:log-group:/aws/eks/${Env}*
          - Effect: Allow
            Action:
              - events:DeleteRule
              - events:DescribeRule
              - events:ListTagsForResource
              - events:ListTargetsByRule
              - events:PutRule
              - events:PutTargets
              - events:RemoveTargets
              - events:TagResource
            Resource:
              - arn:aws:events:${Region}:${Account}:rule/${Env}*
          - Effect: Allow
            Action:
              - vpc-lattice:List*
              - vpc-lattice:Get*
              - vpc-lattice:DeleteServiceNetwork
              - vpc-lattice:DeleteServiceNetworkVpcAssociation
            Resource: ["*"]
          - Effect: Allow
            Action:
              - elasticfilesystem:CreateFileSystem
              - elasticfilesystem:CreateMountTarget
              - elasticfilesystem:DeleteFileSystem
              - elasticfilesystem:DeleteMountTarget
              - elasticfilesystem:DescribeLifecycleConfiguration
              - elasticfilesystem:DescribeMountTargetSecurityGroups
              - elasticfilesystem:DescribeMountTargets
              - elasticfilesystem:CreateTags
              - elasticfilesystem:TagResource
              - elasticfilesystem:DescribeFileSystems
            Resource:
              - arn:aws:elasticfilesystem:${Region}:${Account}:file-system/*
          - Effect: Allow
            Action:
              - ssm:DescribeParameters
              - ssm:ListTagsForResource
            Resource: ["*"]
          - Effect: Allow
            Action:
              - ssm:PutParameter
              - ssm:GetParameter
              - ssm:GetParameters
              - ssm:DeleteParameter
              - ssm:AddTagsToResource
            Resource:
              - arn:aws:ssm:${Region}:${Account}:parameter/${Env}*
          - Effect: Allow
            Action:
              - ssm:GetParameter
            Resource: arn:aws:ssm:${Region}::parameter/aws/service/eks/optimized-ami/*
          - Effect: Allow
            Action:
              - s3:CreateBucket
              - s3:DeleteBucket
              - s3:List*
              - s3:Get*
              - s3:PutBucketPublicAccessBlock
              - s3:PutBucketTagging
              - s3:DeleteObject
              - s3:DeleteObjectVersion
            Resource:
              - arn:aws:s3:::${Env}*
              - arn:aws:s3:::${Env}*/*
          - Effect: Allow
            Action:
              - codecommit:CreateRepository
              - codecommit:GetRepository
              - codecommit:DeleteRepository
              - codecommit:TagResource
              - codecommit:ListTagsForResource
            Resource: arn:aws:codecommit:${Region}:${Account}:${Env}*
